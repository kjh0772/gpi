# 변경: 라즈베리파이에서 gpi 실행/OTA까지 한 번에 설정 (복붙용)
#
# 대상: Raspberry Pi OS (Bookworm/Bullseye), 사용자 pi 기준
# 리포: https://github.com/kjh0772/gpi.git
#
# 사용(복붙):
# - 이 파일(`pi-setup.txt`) 내용을 라즈베리파이 터미널에 그대로 복붙해서 실행하세요.
# - (선택) 리포가 이미 푸시된 상태라면 raw 파일로도 실행 가능:
#     curl -fsSL https://raw.githubusercontent.com/kjh0772/gpi/main/pi-setup.txt | bash
#
# 주의:
# - 센서 사용을 위해 I2C/UART/GPIO 권한이 필요합니다.
# - serialport/better-sqlite3/node-dht-sensor 등은 Pi에서 네이티브 빌드가 필요할 수 있어 빌드 도구를 설치합니다.

set -euo pipefail

echo "[1/7] OS 패키지 업데이트 + 필수 도구 설치"
sudo apt update && sudo apt upgrade -y
sudo apt install -y git curl ca-certificates build-essential python3 make g++ pkg-config
sudo apt install -y i2c-tools

echo "[2/7] Node.js 20 LTS 설치 (Node 18+ 필요)"
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs
node -v
npm -v

echo "[2.1/7] PM2 전역 설치(선행)"
# 변경: PM2 명령을 안정적으로 쓰기 위해 전역 설치
sudo npm install -g pm2
pm2 -v

echo "[3/7] I2C / UART 활성화(가능한 경우 자동) + 권한 그룹 추가"
# raspi-config nonint가 있으면 자동 설정, 없으면 수동 설정 안내만 출력
if command -v raspi-config >/dev/null 2>&1; then
  # I2C ON
  sudo raspi-config nonint do_i2c 0 || true
  # Serial login shell OFF, hardware serial ON
  sudo raspi-config nonint do_serial_cons 1 || true
  sudo raspi-config nonint do_serial_hw 0 || true
fi

# 4) 시리얼(UART) 활성화 & 블루투스 비활성화 설정 (MH-Z19C용)
# config.txt 경로는 OS 버전에 따라 다름
CFG="/boot/config.txt"
if [ -f "/boot/firmware/config.txt" ]; then
  CFG="/boot/firmware/config.txt"
fi
echo "UART config: $CFG"

# config.txt 백업
sudo cp "$CFG" "${CFG}.bak.$(date +%Y%m%d-%H%M%S)"

# enable_uart=1 설정 (있으면 수정, 없으면 추가)
if grep -Eq '^\s*enable_uart=' "$CFG"; then
  sudo sed -i -E 's/^\s*enable_uart=.*/enable_uart=1/' "$CFG"
else
  echo 'enable_uart=1' | sudo tee -a "$CFG" >/dev/null
fi

# dtoverlay=disable-bt 추가(중복 방지)
if ! grep -Eq '^\s*dtoverlay=disable-bt\s*$' "$CFG"; then
  echo 'dtoverlay=disable-bt' | sudo tee -a "$CFG" >/dev/null
fi

# 권한: I2C / UART(dialout) / GPIO 접근
sudo usermod -aG i2c,dialout,gpio pi || true

echo "[4/7] 소스 받기"
cd ~
if [ ! -d "gpi" ]; then
  git clone https://github.com/kjh0772/gpi.git
fi
cd gpi

echo "[5/7] 의존성 설치"
npm install

echo "[6/7] 실행 (권장: PM2)"
# 변경: PM2는 전역 설치되어 있어 pm2 명령 사용 가능
npm run pm2:start
# 변경: 부팅 자동 시작(선택) - PM2 startup 등록
pm2 save
# 변경: 부팅 자동 시작(선택) - PM2 startup 등록 (systemd 폴더는 미사용)
sudo env "PATH=$PATH" pm2 startup systemd -u pi --hp /home/pi || true

echo "[7/7] 동작 확인"
pm2 ls
pm2 logs --lines 100

echo ""
echo "완료. UART 설정 적용을 위해 재부팅이 필요할 수 있습니다:"
echo "  sudo reboot"
echo ""
echo "=== OTA GitHub API용 토큰 (한 번만, 이미 했다면 생략) ==="
echo "부팅 시에도 토큰 적용되도록 프로젝트 안 .env.ota 사용 (ghp_xxx 부분을 실제 토큰으로 교체):"
echo "  echo 'OTA_GH_TOKEN=ghp_여기에_새토큰' > ~/gpi/.env.ota"
echo "  pm2 restart ota-updater"

