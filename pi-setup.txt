# 변경: 라즈베리파이에서 gpi 실행/OTA까지 한 번에 설정 (복붙용)
#
# 대상: Raspberry Pi OS (Bookworm/Bullseye), 사용자 pi 기준
# 리포: https://github.com/kjh0772/gpi.git
#
# 사용:
#   cd ~
#   bash ./pi-setup.txt
#
# 주의:
# - 센서 사용을 위해 I2C/UART/GPIO 권한이 필요합니다.
# - serialport/better-sqlite3/node-dht-sensor 등은 Pi에서 네이티브 빌드가 필요할 수 있어 빌드 도구를 설치합니다.

set -euo pipefail

echo "[1/7] OS 패키지 업데이트 + 필수 도구 설치"
sudo apt update && sudo apt upgrade -y
sudo apt install -y git curl ca-certificates build-essential python3 make g++ pkg-config
sudo apt install -y i2c-tools

echo "[2/7] Node.js 20 LTS 설치 (Node 18+ 필요)"
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs
node -v
npm -v

echo "[3/7] I2C / UART 활성화(가능한 경우 자동) + 권한 그룹 추가"
# raspi-config nonint가 있으면 자동 설정, 없으면 수동 설정 안내만 출력
if command -v raspi-config >/dev/null 2>&1; then
  # I2C ON
  sudo raspi-config nonint do_i2c 0 || true
  # Serial login shell OFF, hardware serial ON
  sudo raspi-config nonint do_serial_cons 1 || true
  sudo raspi-config nonint do_serial_hw 0 || true
fi

# MH-Z19C용 UART 설정(config.txt 경로는 OS 버전에 따라 다름)
CFG="/boot/config.txt"
if [ -f "/boot/firmware/config.txt" ]; then
  CFG="/boot/firmware/config.txt"
fi
echo "UART config: $CFG"
sudo grep -q '^enable_uart=1$' "$CFG" || echo 'enable_uart=1' | sudo tee -a "$CFG" >/dev/null
sudo grep -q '^dtoverlay=disable-bt$' "$CFG" || echo 'dtoverlay=disable-bt' | sudo tee -a "$CFG" >/dev/null

# 권한: I2C / UART(dialout) / GPIO 접근
sudo usermod -aG i2c,dialout,gpio pi || true

echo "[4/7] 소스 받기"
cd ~
if [ ! -d "gpi" ]; then
  git clone https://github.com/kjh0772/gpi.git
fi
cd gpi

echo "[5/7] 의존성 설치"
npm install

echo "[6/7] 실행 (권장: PM2)"
# PM2는 devDependency에 포함되어 있어 npm install 후 사용 가능
npm run pm2:start
# 변경: 로컬 설치 PM2를 확실히 쓰기 위해 npx 사용
npx pm2 save
# 변경: 부팅 자동 시작(선택) - systemd 등록 (비대화형)
sudo env "PATH=$PATH" npx pm2 startup systemd -u pi --hp /home/pi || true

echo "[선택] systemd로 OTA 구성(원하면 아래 블록만 추가로 실행)"
cat <<'EOF'
## systemd 방식(선택)
## - 서비스 파일을 복사하고, WorkingDirectory를 /home/pi/gpi 로 맞춘 뒤 enable 합니다.
##
## sudo cp systemd/ota.service /etc/systemd/system/
## sudo cp systemd/ota-updater.service /etc/systemd/system/
##
## sudo sed -i 's|WorkingDirectory=/home/pi/gpi2|WorkingDirectory=/home/pi/gpi|g' /etc/systemd/system/ota.service
## sudo sed -i 's|WorkingDirectory=/home/pi/gpi2|WorkingDirectory=/home/pi/gpi|g' /etc/systemd/system/ota-updater.service
##
## # updater가 재시작을 수행할 수 있도록 sudoers.d에 권한 부여(권장)
## echo 'pi ALL=(ALL) NOPASSWD: /bin/systemctl restart ota' | sudo tee /etc/sudoers.d/ota-updater
## sudo chmod 440 /etc/sudoers.d/ota-updater
## sudo visudo -cf /etc/sudoers
##
## sudo systemctl daemon-reload
## sudo systemctl enable --now ota
## sudo systemctl enable --now ota-updater
##
## 확인:
## systemctl status ota --no-pager
## systemctl status ota-updater --no-pager
EOF

echo "[7/7] 동작 확인"
npx pm2 ls
npx pm2 logs --lines 100

echo ""
echo "완료. UART 설정 적용을 위해 재부팅이 필요할 수 있습니다:"
echo "  sudo reboot"

